<p-card>
  <div class="flex flex-wrap gap-3 mb-4">

    <p-floatlabel variant="on">
      <p-select id="villeSelect" class="min-w-24" [options]="villes" [(ngModel)]="selectedVille" [filter]="true" filterBy="Nom" (onChange)="applyFilters()" showClear>
        <ng-template let-option #item>
          <p-tag [value]="option"/>
        </ng-template>
        <ng-template let-option #selectedItem>
          <p-tag [value]="option"/>
        </ng-template>
      </p-select>
      <label for="villeSelect">Ville</label>
    </p-floatlabel>
    <p-floatlabel variant="on">
      <p-select id="platSelect" class="min-w-24" [options]="plats" [(ngModel)]="selectedPlat" [filter]="true" filterBy="Nom" (onChange)="applyFilters()" showClear>
        <ng-template let-option #item>
          <p-tag [value]="option.Nom"/>
        </ng-template>
        <ng-template let-option #selectedItem>
          <p-tag [value]="option.Nom"/>
        </ng-template>
      </p-select>
      <label for="platSelect">Plat</label>
    </p-floatlabel>
  </div>
  <p-treetable
    [value]="filteredTreeRestaurants"
    [scrollable]="true"
    [tableStyle]="{'min-width':'50rem'}"
    (onNodeExpand)="onNodeExpand($event)"
    showGridlines
  >
    <ng-template #header>
      <tr>
        <th>Nom</th>
        <th>Plats</th>
        <th>Prix</th>
        <th>Description</th>
        <th>Commentaires</th>
        <th class="w-24">Avis</th>
      </tr>
    </ng-template>
    <ng-template #body let-rowNode let-rowData="rowData">
      <tr [ttRow]="rowNode">
        <td>
          <div class="flex items-center gap-2">
            <p-treetable-toggler [rowNode]="rowNode" />
            <span>
              {{ rowData.Nom }}
              @if (rowData.Localisation) {
                <a href="{{rowData.Localisation}}"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="text-inherit no-underline hover:text-inherit"
                >
                  <i class="fa-solid fa-location-dot"></i>
                </a>
              }
              @if (rowData.Video) {
                <a href="{{rowData.Video}}"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="text-inherit no-underline hover:text-inherit"
                >
                  <i class="fa-brands fa-youtube"></i>
                </a>
              }
              @if (rowData.Menu) {
                <a href="{{rowData.Menu}}"
                   target="_blank"
                   rel="noopener noreferrer"
                   class="text-inherit no-underline hover:text-inherit"
                >
                  <i class="fa-solid fa-book"></i>
                </a>
              }
            </span>
          </div>
        </td>
        <td>
          <div class="flex flex-wrap gap-2">
            @for (plat of rowData.Plats; track plat.Nom) {
              <p-tag
                [value]="plat.Nom"
                [severity]="getPlatSeverity(plat)"
                (click)="showPlatDetails(plat)"
                class="cursor-pointer"
              ></p-tag>
            }
          </div>
        </td>

        <td>{{ rowData.Prix }}</td>
        <td>{{ rowData.Description }}</td>
        <td>{{ rowData.Commentaires }}</td>
        <td class="w-24">
          @if (rowData.Avis) {
            {{ rowData.Avis?.moyenne }}
            <i class="fa-solid fa-star"></i>
          }

        </td>

      </tr>
    </ng-template>
  </p-treetable>
</p-card>

<p-dialog
  header="Détails du Plat"
  [(visible)]="displayPlatDetails"
  [modal]="true"
  [style]="{ width: '25rem' }"
  [draggable]="false"
  [resizable]="false"
  dismissableMask="true"
>

  @if (platToShow) {
    <div class="flex flex-col gap-3">
      <div>
        <span class="font-bold block mb-1">Nom</span>
        <div class="flex items-center gap-x-1">
          <p>{{ platToShow.Nom }}</p>
          @if (platToShow.Wiki) {
            <a
              [href]="platToShow.Wiki"
              target="_blank"
              rel="noopener noreferrer"
              class="text-inherit no-underline hover:text-inherit"
            >
              <i class="fa-brands fa-wikipedia-w"></i>
            </a>
          }
        </div>
      </div>
      <div>
        <span class="font-bold block mb-1">Catégorie</span>
        <p-tag [value]="platToShow.Categorie"></p-tag>
      </div>
      <div>
        <span class="font-bold block mb-1">Description</span>
        <p>{{ platToShow.Description || 'Aucune description disponible' }}</p>
      </div>
      <div>
        <span class="font-bold block mb-1">Commentaires</span>
        <p class="italic text-sm text-gray-600">{{ platToShow.Commentaires || 'Pas de commentaires' }}</p>
      </div>
    </div>
  }

  <ng-template #footer>
    <p-button label="Fermer" icon="pi pi-check" (click)="displayPlatDetails = false" />
  </ng-template>
</p-dialog>

